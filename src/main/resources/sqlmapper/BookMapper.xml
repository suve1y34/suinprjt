<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="co.kr.sikim.suinproject.mapper.BookMapper">
    <resultMap id="BookMap" type="co.kr.sikim.suinproject.domain.Book">
        <id     column="book_id"           property="bookId"/>
        <result column="isbn13_code"       property="isbn13Code"/>
        <result column="title"             property="title"/>
        <result column="author"            property="author"/>
        <result column="pages"             property="pages"/>
        <result column="publisher"         property="publisher"/>
        <result column="pub_date"          property="pubDate"/>
        <result column="cover_image_url"   property="coverImageUrl"/>
        <result column="created_datetime"  property="createdDatetime"/>
        <result column="modified_datetime" property="modifiedDatetime"/>
    </resultMap>

    <resultMap id="PublicReviewMap" type="co.kr.sikim.suinproject.domain.PublicReviewRow">
        <id     column="shelf_book_id"     property="shelfBookId"/>
        <result column="nickname"          property="nickname"/>
        <result column="review"              property="review"/>
        <result column="added_datetime"    property="addedDatetime"/>
    </resultMap>

    <!-- 책 목록 조회 -->
    <select id="selectBooks" resultMap="BookMap">
        SELECT
            b.*
        FROM
            book b
        <where>
            <if test="keyword != null and keyword != ''">
                (title LIKE CONCAT('%', #{keyword}, '%')
                OR author LIKE CONCAT('%', #{keyword}, '%'))
            </if>
        </where>
        ORDER BY
            b.book_id DESC
    </select>

    <!-- 책 상세 조회 -->
    <select id="selectBookById" resultMap="BookMap">
        SELECT
            b.*
        FROM
            book b
        WHERE
            b.book_id = #{bookId}
    </select>

    <select id="existsBookByIsbn13Code" parameterType="string" resultType="boolean">
        SELECT
            EXISTS(
                SELECT 1 FROM book WHERE isbn13_code = #{isbn13Code}
            )
    </select>

    <select id="selectBookByIsbn13Code" parameterType="string" resultMap="BookMap">
        SELECT
            book_id, isbn13_code, title, author, CAST(pages AS SIGNED) AS pages, publisher, pub_date, cover_image_url
        FROM
            book
        WHERE
            isbn13_code = #{isbn13Code}
    </select>

    <insert id="insertBook" parameterType="co.kr.sikim.suinproject.domain.Book"
            useGeneratedKeys="true" keyProperty="bookId" keyColumn="book_id">
        INSERT INTO book (isbn13_code, title, author, pages, publisher, pub_date, cover_image_url)
        VALUES (#{isbn13Code}, #{title}, #{author}, #{pages}, #{publisher}, #{pubDate}, #{coverImageUrl})
    </insert>

    <update id="updateBook" parameterType="co.kr.sikim.suinproject.domain.Book">
        UPDATE book
        SET title = #{title},
        author = #{author},
        pages = #{pages},
        publisher = #{publisher},
        pub_date = #{pubDate},
        cover_image_url = #{coverImageUrl}
        WHERE isbn13_code = #{isbn13Code}
    </update>

    <select id="selectPublicReviewsByIsbn13" resultMap="PublicReviewMap">
        SELECT
            sb.shelf_book_id,
            u.nickname AS nickname,
            sb.review,
            sb.added_datetime
        FROM shelf_book sb
        JOIN bookshelf bs ON bs.bookshelf_id = sb.bookshelf_id
        JOIN book b       ON b.book_id       = sb.book_id
        JOIN `user` u      ON u.user_id       = bs.user_id
        WHERE b.isbn13_code = #{isbn13}
        AND sb.review_visibility = 'PUBLIC'
        AND sb.review IS NOT NULL
        AND TRIM(sb.review) != ''
        <if test="cursorId != null">
            AND sb.shelf_book_id &lt; #{cursorId}
        </if>
        ORDER BY sb.shelf_book_id DESC
        LIMIT #{limit}
    </select>
</mapper>